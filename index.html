<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osorno Runners - Planificador de Entrenamiento</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 50%, #ffffff 100%);
            min-height: 100vh;
        }

        .hero-section {
            background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
            color: white;
            padding: 2rem 0;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M25 25h50v50H25z' fill='none' stroke='white' stroke-width='0.5' opacity='0.1'/%3E%3C/svg%3E");
            animation: pulse 20s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.1; }
            50% { opacity: 0.3; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            position: relative;
            z-index: 1;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 15px;
            display: inline-block;
            margin-left: 50%;
            transform: translateX(-50%);
        }

        .logo {
            max-width: 350px;
            height: auto;
        }

        .hero-content {
            text-align: center;
            position: relative;
            z-index: 2;
            margin-top: 1rem;
        }

        .hero-content h1 {
            font-size: clamp(1.5rem, 3.5vw, 2.2rem);
            font-weight: 900;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: -1px;
        }

        .hero-content p {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            margin-bottom: 0;
            opacity: 0.95;
            font-weight: 300;
        }

        .form-section {
            padding: 3rem 0;
            background: white;
        }

        .form-card {
            background: white;
            border-radius: 20px;
            padding: clamp(1.5rem, 4vw, 3rem);
            box-shadow: 0 20px 60px rgba(220, 20, 60, 0.1);
            border: 1px solid rgba(220, 20, 60, 0.1);
            max-width: 900px;
            margin: 0 auto;
        }

        .form-title {
            text-align: center;
            margin-bottom: 2rem;
            color: #dc143c;
            font-size: clamp(1.5rem, 3vw, 2rem);
            font-weight: 700;
        }

        .form-section-title {
            color: #1a1a1a;
            font-size: 1.2rem;
            font-weight: 700;
            margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #dc143c;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #1a1a1a;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            color: #1a1a1a;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #dc143c;
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
            transform: translateY(-2px);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-item:hover {
            background: #ffe5e5;
        }

        .checkbox-item input[type="checkbox"],
        .checkbox-item input[type="radio"] {
            width: auto;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .conditional-field {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #dc143c;
        }

        .prep-race {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid #dc143c;
        }

        .prep-race-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .btn-remove {
            background: #dc143c;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .btn-add {
            background: #1a1a1a;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .btn-add:hover, .btn-remove:hover {
            opacity: 0.8;
        }

        .btn-container {
            text-align: center;
            margin-top: 2rem;
        }

        .btn {
            background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(220, 20, 60, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(220, 20, 60, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            margin-left: 1rem;
        }

        .plan-container {
            display: none;
            margin-top: 2rem;
            background: white;
            padding: 2rem 0;
        }

        .plan-header {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 15px 40px rgba(220, 20, 60, 0.1);
            border: 1px solid rgba(220, 20, 60, 0.1);
        }

        .plan-header h2 {
            color: #dc143c;
            margin-bottom: 1.5rem;
            font-size: clamp(1.5rem, 3vw, 2rem);
            font-weight: 800;
            text-align: center;
        }

        .plan-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .info-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 12px;
            border-left: 4px solid #dc143c;
            text-align: center;
        }

        .info-item strong {
            color: #dc143c;
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-item span {
            color: #1a1a1a;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .period-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(220, 20, 60, 0.1);
        }

        .period-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            color: white;
            padding: 1.2rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            text-transform: uppercase;
        }

        .period-description {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #dc143c;
        }

        .week-card {
            background: white;
            border-radius: 15px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #e8e8e8;
        }

        .week-card.race-week {
            border: 3px solid #dc143c;
            box-shadow: 0 12px 30px rgba(220, 20, 60, 0.3);
        }

        .week-header {
            background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
            color: white;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            text-align: center;
        }

        .week-header.race-week-header {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #1a1a1a;
            font-size: 1.3rem;
        }

        .training-grid {
            display: grid;
            gap: 1px;
            background: #e8e8e8;
        }

        .training-day {
            background: white;
            padding: 1.5rem;
        }

        .training-day.race-day {
            background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%);
            border: 2px solid #ffd700;
        }

        .day-header {
            display: grid;
            grid-template-columns: 100px 1fr 90px;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .day-header {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 0.5rem;
            }
        }

        .day-name {
            font-weight: 800;
            color: #dc143c;
            font-size: 0.95rem;
            text-transform: uppercase;
        }

        .session-type {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 1rem;
        }

        .session-distance {
            background: #dc143c;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
        }

        .shoe-recommendation {
            background: #1a1a1a;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-block;
            margin-top: 0.5rem;
        }

        .session-details {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.2rem;
            border-left: 4px solid #dc143c;
        }

        .session-phase {
            margin-bottom: 0.8rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid #e8e8e8;
        }

        .session-phase:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .phase-title {
            color: #dc143c;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .phase-content {
            color: #333;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .training-purpose {
            background: #fff3f3;
            border: 1px solid #ffd6d6;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .purpose-title {
            color: #8b0000;
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 0.4rem;
            text-transform: uppercase;
        }

        .purpose-content {
            color: #666;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .motivational-message {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #1a1a1a;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1rem;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
            border: 3px solid #ffd700;
        }

        .volume-summary {
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            color: white;
            padding: 1.2rem;
            border-radius: 12px;
            margin: 1.2rem;
            text-align: center;
            font-weight: 600;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(220, 20, 60, 0.1);
        }

        .loading .spinner {
            border: 4px solid rgba(220, 20, 60, 0.3);
            border-radius: 50%;
            border-top: 4px solid #dc143c;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: #dc143c;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .small-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.3rem;
        }

        .prep-race-badge {
            display: inline-block;
            background: #dc143c;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 0.2rem;
        }

        @media print {
            body { 
                background: white; 
                font-size: 9px;
            }
            .hero-section, .form-section, .btn { display: none; }
            .plan-container { display: block !important; margin: 0; padding: 0; }
            .period-section, .week-card { 
                break-inside: avoid; 
                margin-bottom: 10px; 
                box-shadow: none;
                border: 1px solid #ccc;
            }
            .training-day { padding: 8px; font-size: 8px; }
            .session-details { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="hero-section">
        <div class="container">
            <div class="logo-container">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3Ctext x='350' y='280' font-family='Arial Black' font-size='60' fill='%23dc143c' text-anchor='middle' font-weight='900'%3EOSORNO RUNNERS%3C/text%3E%3C/svg%3E" alt="Osorno Runners Logo" class="logo">
            </div>
            <div class="hero-content">
                <h1>PLANIFICADOR DE ENTRENAMIENTO</h1>
                <p>Sistema profesional de planificaci√≥n deportiva</p>
            </div>
        </div>
    </div>

    <div class="form-section">
        <div class="container">
            <div class="form-card">
                <h2 class="form-title">Formulario de Planificaci√≥n</h2>
                <form id="trainingForm">
                    
                    <!-- DATOS PERSONALES -->
                    <h3 class="form-section-title">üìã Datos Personales</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name">Nombre completo *</label>
                            <input type="text" id="name" required placeholder="Ingresa tu nombre completo">
                        </div>
                        <div class="form-group">
                            <label for="age">Edad *</label>
                            <input type="number" id="age" min="16" max="80" required placeholder="38">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="experience">Nivel de experiencia *</label>
                            <select id="experience" required onchange="toggleFirstTimeField()">
                                <option value="">Selecciona tu nivel</option>
                                <option value="principiante">Principiante (0-1 a√±o corriendo)</option>
                                <option value="intermedio">Intermedio (1-3 a√±os corriendo)</option>
                                <option value="avanzado">Avanzado (+3 a√±os corriendo)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="currentLongRun">Distancia larga actual (km) *</label>
                            <input type="number" id="currentLongRun" min="3" max="35" required placeholder="10">
                            <div class="small-text">¬øCu√°l es la distancia m√°s larga que puedes correr c√≥modamente ahora?</div>
                        </div>
                    </div>

                    <div id="firstTimeField" class="conditional-field">
                        <label>
                            <input type="checkbox" id="firstTimeDistance"> 
                            Es mi primera vez en esta distancia
                        </label>
                    </div>

                    <!-- OBJETIVO -->
                    <h3 class="form-section-title">üéØ Objetivo de Carrera</h3>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="distance">Distancia objetivo *</label>
                            <select id="distance" required>
                                <option value="">Selecciona</option>
                                <option value="5K">5K</option>
                                <option value="10K">10K</option>
                                <option value="21K">21K (Medio Marat√≥n)</option>
                                <option value="42K">42K (Marat√≥n)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="raceDate">Fecha del objetivo *</label>
                            <input type="date" id="raceDate" required>
                        </div>
                        <div class="form-group">
                            <label for="pace">Ritmo deseado (min/km) *</label>
                            <input type="text" id="pace" required placeholder="5:30" pattern="[0-9]:[0-5][0-9]">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="weeksAvailable">Semanas disponibles *</label>
                        <input type="number" id="weeksAvailable" min="8" max="32" required placeholder="16">
                        <div class="small-text">¬øCu√°ntas semanas tienes desde HOY hasta la fecha de tu carrera objetivo?</div>
                    </div>

                    <!-- DISPONIBILIDAD -->
                    <h3 class="form-section-title">üìÖ Disponibilidad de Entrenamiento</h3>
                    <div class="form-group">
                        <label>D√≠as disponibles para entrenar *</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="trainingDays" value="Lunes"> Lunes
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="trainingDays" value="Martes"> Martes
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="trainingDays" value="Mi√©rcoles"> Mi√©rcoles
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="trainingDays" value="Jueves"> Jueves
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="trainingDays" value="Viernes"> Viernes
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="trainingDays" value="S√°bado"> S√°bado
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="trainingDays" value="Domingo"> Domingo
                            </label>
                        </div>
                    </div>

                    <!-- ENTRENAMIENTO CRUZADO -->
                    <h3 class="form-section-title">üö¥‚Äç‚ôÇÔ∏è Entrenamiento Cruzado (Opcional)</h3>
                    <div class="form-group">
                        <label>¬øRealizas otros deportes complementarios?</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="crossTraining" value="Ciclismo"> Ciclismo
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="crossTraining" value="Nataci√≥n"> Nataci√≥n
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="crossTraining" value="Gimnasio"> Gimnasio
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="crossTraining" value="Yoga"> Yoga
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="crossTraining" value="Otro"> Otro
                            </label>
                        </div>
                    </div>

                    <!-- MONITOREO -->
                    <h3 class="form-section-title">‚åö Monitoreo y Tecnolog√≠a</h3>
                    <div class="form-group">
                        <label>¬øPosees reloj deportivo?</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="radio" name="hasWatch" value="si" onchange="toggleWatchFields()"> S√≠
                            </label>
                            <label class="checkbox-item">
                                <input type="radio" name="hasWatch" value="no" onchange="toggleWatchFields()"> No
                            </label>
                        </div>
                    </div>

                    <div id="watchFields" class="conditional-field">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hrMax">FC M√°xima (bpm)</label>
                                <input type="number" id="hrMax" min="120" max="220" placeholder="185">
                                <div class="small-text">Si no la conoces, se calcular√° con: 220 - edad</div>
                            </div>
                            <div class="form-group">
                                <label for="hrRest">FC en Reposo (bpm)</label>
                                <input type="number" id="hrRest" min="30" max="100" placeholder="60">
                                <div class="small-text">M√≠dela en la ma√±ana antes de levantarte</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="vo2max">VO2 Max (ml/kg/min)</label>
                            <input type="number" id="vo2max" min="20" max="90" step="0.1" placeholder="45.5">
                            <div class="small-text">Si tu reloj lo mide, ingr√©salo aqu√≠ (opcional)</div>
                        </div>
                    </div>

                    <!-- CARRERAS PREPARATORIAS -->
                    <h3 class="form-section-title">üèÅ Carreras Preparatorias (Opcional)</h3>
                    <div class="small-text" style="margin-bottom: 1rem;">Agregar carreras de preparaci√≥n te ayudar√° a medir tu progreso y ajustar ritmos</div>
                    <div id="prepRacesContainer">
                        <!-- Las carreras se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                    <button type="button" class="btn-add" onclick="addPrepRace()">‚ûï Agregar Carrera Preparatoria</button>

                    <div class="btn-container">
                        <button type="submit" class="btn">Generar Plan de Entrenamiento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Creando tu plan personalizado de entrenamiento...</p>
        </div>

        <div class="plan-container" id="planContainer">
            <div class="plan-header">
                <h2>Tu Plan de Entrenamiento Personalizado</h2>
                <div class="plan-info" id="planInfo"></div>
                <div class="btn-container">
                    <button onclick="generatePDF()" class="btn btn-secondary">üìÑ Descargar PDF</button>
                </div>
            </div>
            <div id="trainingPlan"></div>
        </div>
    </div>

    <script>
        let currentPlan = null;
        let prepRaceCounter = 0;

        function toggleFirstTimeField() {
            const experience = document.getElementById('experience').value;
            const field = document.getElementById('firstTimeField');
            if (experience === 'principiante') {
                field.style.display = 'block';
            } else {
                field.style.display = 'none';
                document.getElementById('firstTimeDistance').checked = false;
            }
        }

        function toggleWatchFields() {
            const hasWatch = document.querySelector('input[name="hasWatch"]:checked');
            const field = document.getElementById('watchFields');
            if (hasWatch && hasWatch.value === 'si') {
                field.style.display = 'block';
            } else {
                field.style.display = 'none';
            }
        }

        function addPrepRace() {
            prepRaceCounter++;
            const container = document.getElementById('prepRacesContainer');
            const raceDiv = document.createElement('div');
            raceDiv.className = 'prep-race';
            raceDiv.id = `prepRace${prepRaceCounter}`;
            raceDiv.innerHTML = `
                <div class="prep-race-header">
                    <strong>Carrera ${prepRaceCounter}</strong>
                    <button type="button" class="btn-remove" onclick="removePrepRace(${prepRaceCounter})">‚úï Eliminar</button>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>Distancia</label>
                        <select class="prep-race-distance">
                            <option value="5K">5K</option>
                            <option value="10K">10K</option>
                            <option value="15K">15K</option>
                            <option value="21K">21K</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha estimada</label>
                        <input type="date" class="prep-race-date">
                    </div>
                    <div class="form-group">
                        <label>Nombre (opcional)</label>
                        <input type="text" class="prep-race-name" placeholder="Ej: Carrera de la Ciudad">
                    </div>
                </div>
            `;
            container.appendChild(raceDiv);
        }

        function removePrepRace(id) {
            const element = document.getElementById(`prepRace${id}`);
            if (element) element.remove();
        }

        document.getElementById('trainingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedDays = Array.from(document.querySelectorAll('input[name="trainingDays"]:checked'));
            if (selectedDays.length < 3) {
                alert('Por favor selecciona al menos 3 d√≠as de entrenamiento.');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('planContainer').style.display = 'none';
            
            const formData = collectFormData();
            
            setTimeout(() => {
                currentPlan = generateTrainingPlan(formData);
                displayPlan(currentPlan);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('planContainer').style.display = 'block';
                document.getElementById('planContainer').scrollIntoView({ behavior: 'smooth' });
            }, 2500);
        });

        function collectFormData() {
            const prepRaces = [];
            document.querySelectorAll('.prep-race').forEach(race => {
                const distance = race.querySelector('.prep-race-distance').value;
                const date = race.querySelector('.prep-race-date').value;
                const name = race.querySelector('.prep-race-name').value;
                if (date) {
                    prepRaces.push({ distance, date, name: name || `Carrera ${distance}` });
                }
            });

            const selectedDays = Array.from(document.querySelectorAll('input[name="trainingDays"]:checked'))
                .map(cb => cb.value);

            const crossTraining = Array.from(document.querySelectorAll('input[name="crossTraining"]:checked'))
                .map(cb => cb.value);

            const hasWatch = document.querySelector('input[name="hasWatch"]:checked');
            const watchData = hasWatch && hasWatch.value === 'si';

            const hrMax = watchData && document.getElementById('hrMax').value ? 
                parseInt(document.getElementById('hrMax').value) : 
                (220 - parseInt(document.getElementById('age').value));
            
            return {
                name: document.getElementById('name').value,
                age: parseInt(document.getElementById('age').value),
                experience: document.getElementById('experience').value,
                firstTimeDistance: document.getElementById('firstTimeDistance').checked,
                currentLongRun: parseInt(document.getElementById('currentLongRun').value),
                distance: document.getElementById('distance').value,
                raceDate: document.getElementById('raceDate').value,
                pace: document.getElementById('pace').value,
                weeksAvailable: parseInt(document.getElementById('weeksAvailable').value),
                trainingDays: selectedDays,
                crossTraining: crossTraining,
                hasWatch: watchData,
                hrMax: hrMax,
                hrRest: watchData && document.getElementById('hrRest').value ? 
                    parseInt(document.getElementById('hrRest').value) : null,
                vo2max: watchData && document.getElementById('vo2max').value ? 
                    parseFloat(document.getElementById('vo2max').value) : null,
                prepRaces: prepRaces
            };
        }

        function generateTrainingPlan(data) {
            const periods = calculatePeriods(data.weeksAvailable, data.distance);
            const weeklyPlans = generateWeeklyPlansWithPeriods(data, periods);
            
            return {
                userData: data,
                periods: periods,
                weeklyPlans: weeklyPlans,
                totalWeeks: data.weeksAvailable
            };
        }

        function calculatePeriods(totalWeeks, distance) {
            let periods = {};
            
            if (distance === '42K') {
                if (totalWeeks >= 20) {
                    periods = {
                        basico: { weeks: Math.floor(totalWeeks * 0.30), name: 'Per√≠odo Base' },
                        especifico: { weeks: Math.floor(totalWeeks * 0.45), name: 'Per√≠odo Espec√≠fico' },
                        competencia: { weeks: Math.floor(totalWeeks * 0.20), name: 'Per√≠odo de Competencia' },
                        transicion: { weeks: Math.floor(totalWeeks * 0.05), name: 'Per√≠odo de Transici√≥n' }
                    };
                } else {
                    periods = {
                        basico: { weeks: Math.floor(totalWeeks * 0.35), name: 'Per√≠odo Base' },
                        especifico: { weeks: Math.floor(totalWeeks * 0.40), name: 'Per√≠odo Espec√≠fico' },
                        competencia: { weeks: Math.floor(totalWeeks * 0.20), name: 'Per√≠odo de Competencia' },
                        transicion: { weeks: Math.floor(totalWeeks * 0.05), name: 'Per√≠odo de Transici√≥n' }
                    };
                }
            } else if (distance === '21K') {
                if (totalWeeks >= 16) {
                    periods = {
                        basico: { weeks: Math.floor(totalWeeks * 0.35), name: 'Per√≠odo Base' },
                        especifico: { weeks: Math.floor(totalWeeks * 0.40), name: 'Per√≠odo Espec√≠fico' },
                        competencia: { weeks: Math.floor(totalWeeks * 0.20), name: 'Per√≠odo de Competencia' },
                        transicion: { weeks: Math.floor(totalWeeks * 0.05), name: 'Per√≠odo de Transici√≥n' }
                    };
                } else {
                    periods = {
                        basico: { weeks: Math.floor(totalWeeks * 0.40), name: 'Per√≠odo Base' },
                        especifico: { weeks: Math.floor(totalWeeks * 0.35), name: 'Per√≠odo Espec√≠fico' },
                        competencia: { weeks: Math.floor(totalWeeks * 0.20), name: 'Per√≠odo de Competencia' },
                        transicion: { weeks: Math.floor(totalWeeks * 0.05), name: 'Per√≠odo de Transici√≥n' }
                    };
                }
            } else if (distance === '10K') {
                periods = {
                    basico: { weeks: Math.floor(totalWeeks * 0.40), name: 'Per√≠odo Base' },
                    especifico: { weeks: Math.floor(totalWeeks * 0.35), name: 'Per√≠odo Espec√≠fico' },
                    competencia: { weeks: Math.floor(totalWeeks * 0.20), name: 'Per√≠odo de Competencia' },
                    transicion: { weeks: Math.floor(totalWeeks * 0.05), name: 'Per√≠odo de Transici√≥n' }
                };
            } else {
                periods = {
                    basico: { weeks: Math.floor(totalWeeks * 0.45), name: 'Per√≠odo Base' },
                    especifico: { weeks: Math.floor(totalWeeks * 0.30), name: 'Per√≠odo Espec√≠fico' },
                    competencia: { weeks: Math.floor(totalWeeks * 0.20), name: 'Per√≠odo de Competencia' },
                    transicion: { weeks: Math.floor(totalWeeks * 0.05), name: 'Per√≠odo de Transici√≥n' }
                };
            }
            
            const sum = Object.values(periods).reduce((acc, p) => acc + p.weeks, 0);
            if (sum < totalWeeks) {
                periods.especifico.weeks += (totalWeeks - sum);
            }
            
            return periods;
        }

        function generateWeeklyPlansWithPeriods(data, periods) {
            const weeks = [];
            let currentWeek = 1;
            const paceComponents = data.pace.split(':');
            const targetPaceSeconds = parseInt(paceComponents[0]) * 60 + parseInt(paceComponents[1]);
            
            // Calcular semana de la carrera objetivo
            const raceWeek = data.weeksAvailable;
            
            for (let i = 0; i < periods.basico.weeks; i++, currentWeek++) {
                weeks.push(generateWeekPlan(currentWeek, 'basico', data, targetPaceSeconds, periods.basico.weeks, i, raceWeek));
            }
            
            for (let i = 0; i < periods.especifico.weeks; i++, currentWeek++) {
                weeks.push(generateWeekPlan(currentWeek, 'especifico', data, targetPaceSeconds, periods.especifico.weeks, i, raceWeek));
            }
            
            for (let i = 0; i < periods.competencia.weeks; i++, currentWeek++) {
                weeks.push(generateWeekPlan(currentWeek, 'competencia', data, targetPaceSeconds, periods.competencia.weeks, i, raceWeek));
            }
            
            for (let i = 0; i < periods.transicion.weeks; i++, currentWeek++) {
                weeks.push(generateWeekPlan(currentWeek, 'transicion', data, targetPaceSeconds, periods.transicion.weeks, i, raceWeek));
            }
            
            weeks.forEach(week => {
                data.prepRaces.forEach(race => {
                    const raceWeekNum = calculateWeekFromDate(data.raceDate, race.date, data.weeksAvailable);
                    if (week.week === raceWeekNum) {
                        week.prepRace = race;
                    }
                });
            });
            
            return weeks;
        }

        function calculateWeekFromDate(raceDate, prepDate, totalWeeks) {
            const race = new Date(raceDate);
            const prep = new Date(prepDate);
            const diffTime = race - prep;
            const diffWeeks = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 7));
            return totalWeeks - diffWeeks;
        }

        function generateWeekPlan(weekNum, period, data, targetPaceSeconds, periodWeeks, weekInPeriod, raceWeek) {
            const sessions = [];
            const trainingDays = data.trainingDays;
            const progressFactor = (weekInPeriod + 1) / periodWeeks;
            const baseDistances = getBaseDistances(period, data.distance, data.currentLongRun, progressFactor, data.firstTimeDistance);
            const sessionTypes = assignSessionsToDays(trainingDays, period, data.distance, data.crossTraining, baseDistances);
            
            const isRaceWeek = weekNum === raceWeek;
            
            trainingDays.forEach((day, index) => {
                const sessionType = sessionTypes[index];
                const session = {
                    day: day,
                    type: sessionType.type,
                    distance: sessionType.distance,
                    details: generateSessionDescription(sessionType.type, period, targetPaceSeconds, data.hrMax, data.crossTraining),
                    purpose: getSessionPurpose(sessionType.type),
                    shoeRecommendation: getShoeRecommendation(sessionType.type)
                };
                
                if (isRaceWeek && index === trainingDays.length - 1) {
                    session.isRaceDay = true;
                    session.type = `CARRERA OBJETIVO - ${data.distance}`;
                    session.distance = data.distance;
                    session.motivationalMessage = getMotivationalMessage(data.name, data.distance);
                }
                
                sessions.push(session);
            });
            
            let totalKm = 0;
            sessions.forEach(session => {
                const distStr = session.distance.replace(/[^\d]/g, '');
                const dist = parseInt(distStr) || 0;
                totalKm += dist;
            });
            
            return {
                week: weekNum,
                period: period,
                sessions: sessions,
                totalKm: totalKm,
                isRaceWeek: isRaceWeek
            };
        }

        function getBaseDistances(period, targetDistance, currentLongRun, progressFactor, isFirstTime) {
            const modifier = isFirstTime ? 0.9 : 1.0;
            
            const distances = {
                'basico': {
                    '5K': { 
                        easy: `${Math.round(4 * modifier)} km`, 
                        interval: `${Math.round(5 * modifier)} km`, 
                        tempo: `${Math.round(5 * modifier)} km`, 
                        long: `${Math.round((currentLongRun + progressFactor * 2) * modifier)} km` 
                    },
                    '10K': { 
                        easy: `${Math.round(6 * modifier)} km`, 
                        interval: `${Math.round(7 * modifier)} km`, 
                        tempo: `${Math.round(7 * modifier)} km`, 
                        long: `${Math.round((currentLongRun + progressFactor * 4) * modifier)} km` 
                    },
                    '21K': { 
                        easy: `${Math.round(8 * modifier)} km`, 
                        interval: `${Math.round(9 * modifier)} km`, 
                        tempo: `${Math.round(9 * modifier)} km`, 
                        long: `${Math.round((currentLongRun + progressFactor * 8) * modifier)} km` 
                    },
                    '42K': { 
                        easy: `${Math.round(10 * modifier)} km`, 
                        interval: `${Math.round(11 * modifier)} km`, 
                        tempo: `${Math.round(11 * modifier)} km`, 
                        long: `${Math.round((currentLongRun + progressFactor * 12) * modifier)} km` 
                    }
                },
                'especifico': {
                    '5K': { easy: '5 km', interval: '6 km', tempo: '6 km', long: `${Math.round(7 + progressFactor * 2)} km` },
                    '10K': { easy: '7 km', interval: '8 km', tempo: '8 km', long: `${Math.round(12 + progressFactor * 4)} km` },
                    '21K': { easy: '9 km', interval: '10 km', tempo: '12 km', long: `${Math.round(16 + progressFactor * 8)} km` },
                    '42K': { easy: '12 km', interval: '13 km', tempo: '15 km', long: `${Math.round(25 + progressFactor * 12)} km` }
                },
                'competencia': {
                    '5K': { easy: '4 km', interval: '5 km', tempo: '5 km', long: '6 km' },
                    '10K': { easy: '6 km', interval: '7 km', tempo: '7 km', long: '10 km' },
                    '21K': { easy: '8 km', interval: '10 km', tempo: '10 km', long: '18 km' },
                    '42K': { easy: '10 km', interval: '12 km', tempo: '15 km', long: '30 km' }
                },
                'transicion': {
                    '5K': { easy: '3 km', interval: '0 km', tempo: '0 km', long: '4 km', recovery: '3 km' },
                    '10K': { easy: '4 km', interval: '0 km', tempo: '0 km', long: '6 km', recovery: '4 km' },
                    '21K': { easy: '5 km', interval: '0 km', tempo: '0 km', long: '8 km', recovery: '5 km' },
                    '42K': { easy: '6 km', interval: '0 km', tempo: '0 km', long: '10 km', recovery: '6 km' }
                }
            };
            
            return distances[period][targetDistance];
        }

        function assignSessionsToDays(trainingDays, period, targetDistance, crossTraining, baseDistances) {
            const sessions = [];
            const numDays = trainingDays.length;
            const hasCrossTraining = crossTraining.length > 0;
            
            if (period === 'basico') {
                for (let i = 0; i < numDays; i++) {
                    if (i === 0) sessions.push({ type: 'Trote f√°cil', distance: baseDistances['easy'] });
                    else if (i === 1 && hasCrossTraining) sessions.push({ type: 'Descanso activo', distance: baseDistances['easy'] });
                    else if (i === 1) sessions.push({ type: 'Tempo run', distance: baseDistances['tempo'] });
                    else if (i === 2) sessions.push({ type: 'Descanso activo', distance: baseDistances['easy'] });
                    else if (i === numDays - 1) sessions.push({ type: 'Carrera larga', distance: baseDistances['long'] });
                    else sessions.push({ type: 'Trote f√°cil', distance: baseDistances['easy'] });
                }
            } else if (period === 'especifico') {
                for (let i = 0; i < numDays; i++) {
                    if (i === 0) sessions.push({ type: 'Trote f√°cil', distance: baseDistances['easy'] });
                    else if (i === 1) sessions.push({ type: 'Intervalos', distance: baseDistances['interval'] });
                    else if (i === 2) sessions.push({ type: 'Descanso activo', distance: baseDistances['easy'] });
                    else if (i === 3) sessions.push({ type: 'Tempo run', distance: baseDistances['tempo'] });
                    else if (i === numDays - 1) sessions.push({ type: 'Carrera larga', distance: baseDistances['long'] });
                    else sessions.push({ type: 'Recuperaci√≥n', distance: baseDistances['easy'] });
                }
            } else if (period === 'competencia') {
                for (let i = 0; i < numDays; i++) {
                    if (i === 0) sessions.push({ type: 'Trote f√°cil', distance: baseDistances['easy'] });
                    else if (i === 1) sessions.push({ type: 'Intervalos', distance: baseDistances['interval'] });
                    else if (i === 2) sessions.push({ type: 'Descanso activo', distance: baseDistances['easy'] });
                    else if (i === 3) sessions.push({ type: 'Tempo run', distance: baseDistances['tempo'] });
                    else if (i === numDays - 1) sessions.push({ type: 'Carrera larga', distance: baseDistances['long'] });
                    else sessions.push({ type: 'Recuperaci√≥n', distance: baseDistances['easy'] });
                }
            } else {
                for (let i = 0; i < numDays; i++) {
                    if (i === 0) sessions.push({ type: 'Descanso', distance: '0 km' });
                    else if (i === numDays - 1) sessions.push({ type: 'Trote f√°cil', distance: baseDistances['easy'] });
                    else sessions.push({ type: 'Recuperaci√≥n', distance: baseDistances['recovery'] || baseDistances['easy'] });
                }
            }
            
            return sessions;
        }

        function generateSessionDescription(type, period, targetPaceSeconds, hrMax, crossTraining) {
            const easyPace = formatPace(targetPaceSeconds + 30);
            const tempoPace = formatPace(targetPaceSeconds - 10);
            const intervalPace = formatPace(targetPaceSeconds - 20);
            
            const hrZones = {
                recovery: `${Math.round(hrMax * 0.60)}-${Math.round(hrMax * 0.70)} bpm`,
                easy: `${Math.round(hrMax * 0.65)}-${Math.round(hrMax * 0.75)} bpm`,
                tempo: `${Math.round(hrMax * 0.80)}-${Math.round(hrMax * 0.85)} bpm`,
                interval: `${Math.round(hrMax * 0.85)}-${Math.round(hrMax * 0.90)} bpm`
            };

            const crossTrainingOptions = crossTraining.length > 0 ? 
                ` Opciones: ${crossTraining.join(', ')}` : '';
            
            const descriptions = {
                'Trote f√°cil': {
                    warmup: `10 min caminata din√°mica + 5 min trote suave`,
                    main: `Trote continuo a ${easyPace}/km. FC: ${hrZones.easy}. Conversaci√≥n f√°cil.`,
                    cooldown: `5 min caminata + 10 min estiramientos est√°ticos`
                },
                'Intervalos': {
                    warmup: `15 min trote f√°cil + 6 ejercicios din√°micos + 4 progresivos 100m`,
                    main: `6-8x400m a ${intervalPace}/km con 90 seg recuperaci√≥n. FC: ${hrZones.interval}`,
                    cooldown: `10 min trote suave + 15 min estiramientos completos`
                },
                'Descanso activo': {
                    warmup: `5 min caminata ligera o movilidad`,
                    main: `Trote muy suave a ${formatPace(targetPaceSeconds + 60)}/km o cross-training (30-45 min). FC: ${hrZones.recovery}.${crossTrainingOptions}`,
                    cooldown: `10 min estiramientos + movilidad + rodillo espuma`
                },
                'Tempo run': {
                    warmup: `15 min trote f√°cil + 4 progresivos de 100m`,
                    main: `20-30 min a ${tempoPace}/km. FC: ${hrZones.tempo}. Ritmo sostenido "c√≥modamente duro".`,
                    cooldown: `10 min trote f√°cil + 15 min estiramientos`
                },
                'Descanso': {
                    warmup: `D√≠a de descanso completo`,
                    main: `Descanso total. Masaje/kinesiolog√≠a si est√° programado. Enfoque en recuperaci√≥n.`,
                    cooldown: `Hidrataci√≥n y nutrici√≥n para recuperaci√≥n √≥ptima`
                },
                'Carrera larga': {
                    warmup: `15 min trote muy f√°cil + movilidad completa + activaci√≥n gl√∫teos`,
                    main: `Carrera continua a ${formatPace(targetPaceSeconds + 20)}/km. FC: ${hrZones.easy}. Hidrataci√≥n cada 20 min (200ml). Gel cada 45 min si >90 min.`,
                    cooldown: `10 min caminata + 20 min estiramientos profundos + rodillo espuma + hidrataci√≥n con electrolitos`
                },
                'Recuperaci√≥n': {
                    warmup: `5 min caminata suave con respiraciones profundas`,
                    main: `Trote muy f√°cil a ${formatPace(targetPaceSeconds + 50)}/km. FC: ${hrZones.recovery}. Enfoque total en recuperaci√≥n.`,
                    cooldown: `15 min estiramientos suaves + fortalecimiento core (plancha, puente) + ba√±o contraste si es posible`
                }
            };
            
            return descriptions[type] || descriptions['Trote f√°cil'];
        }

        function getSessionPurpose(type) {
            const purposes = {
                'Trote f√°cil': {
                    title: 'üéØ Objetivo del Trote F√°cil',
                    content: 'Desarrolla base aer√≥bica y eficiencia cardiovascular. Fortalece tendones, ligamentos y m√∫sculos progresivamente sin generar fatiga excesiva.'
                },
                'Intervalos': {
                    title: 'üéØ Objetivo de los Intervalos',
                    content: 'Mejora VO2 m√°ximo y potencia anaer√≥bica. Aumenta capacidad de procesar ox√≠geno y mantener ritmos r√°pidos por m√°s tiempo.'
                },
                'Descanso activo': {
                    title: 'üéØ Objetivo del Descanso Activo',
                    content: 'Facilita recuperaci√≥n muscular manteniendo flujo sangu√≠neo. Elimina metabolitos y mantiene movilidad sin generar fatiga. Ideal para entrenamiento cruzado.'
                },
                'Tempo run': {
                    title: 'üéØ Objetivo del Tempo Run',
                    content: 'Mejora umbral de lactato y resistencia anaer√≥bica. Entrena al cuerpo para mantener esfuerzo sostenido sin acumular lactato.'
                },
                'Descanso': {
                    title: 'üéØ Objetivo del Descanso',
                    content: 'Regeneraci√≥n completa de fibras musculares y reposici√≥n de gluc√≥geno. El cuerpo se fortalece durante el descanso, crucial para adaptaci√≥n.'
                },
                'Carrera larga': {
                    title: 'üéØ Objetivo de la Carrera Larga',
                    content: 'Desarrolla resistencia aer√≥bica y eficiencia energ√©tica. Mejora uso de grasa como combustible y prepara mental y f√≠sicamente para la distancia.'
                },
                'Recuperaci√≥n': {
                    title: 'üéØ Objetivo de la Recuperaci√≥n',
                    content: 'Mantiene ritmo de entrenamiento con recuperaci√≥n activa. Mejora circulaci√≥n para eliminar toxinas y mantiene mec√°nica sin fatiga adicional.'
                }
            };
            
            return purposes[type] || purposes['Trote f√°cil'];
        }

        function getShoeRecommendation(type) {
            const shoes = {
                'Trote f√°cil': 'üëü Zapatilla: Entrenamiento diario / Mixta',
                'Intervalos': 'üëü Zapatilla: Voladora / Competencia',
                'Descanso activo': 'üëü Zapatilla: Entrenamiento diario',
                'Tempo run': 'üëü Zapatilla: Mixta / Tempo',
                'Descanso': '',
                'Carrera larga': 'üëü Zapatilla: Entrenamiento diario / Maximalista',
                'Recuperaci√≥n': 'üëü Zapatilla: Entrenamiento diario'
            };
            
            return shoes[type] || '';
        }

        function getMotivationalMessage(name, distance) {
            const messages = {
                '5K': `¬°Hoy es tu d√≠a, ${name}! Has entrenado duro para esto. Conf√≠a en tu preparaci√≥n, mant√©n tu ritmo y disfruta cada zancada. ¬°A por esos 5K! üèÉ‚Äç‚ôÇÔ∏èüí™üî•`,
                '10K': `¬°${name}, lleg√≥ el momento! Todo el trabajo duro te trajo hasta aqu√≠. Sal con confianza, mant√©n tu estrategia y termina fuerte. ¬°Esos 10K son tuyos! üèÉ‚Äç‚ôÇÔ∏èüí™üî•`,
                '21K': `¬°Es tu d√≠a de gloria, ${name}! Has corrido cientos de kil√≥metros para este momento. Conf√≠a en tu entrenamiento, respeta el medio marat√≥n pero no le temas. Sal con inteligencia, mant√©n tu ritmo y cruza esa meta con la cabeza en alto. ¬°A conquistar esos 21K! üèÉ‚Äç‚ôÇÔ∏èüí™üî•üéØ`,
                '42K': `¬°${name}, hoy escribes tu historia en el marat√≥n! Cada kil√≥metro entrenado te prepar√≥ para este momento √©pico. Los primeros 30K son con la cabeza, los √∫ltimos 12K con el coraz√≥n. Conf√≠a en tu plan, respeta la distancia, mant√©n tu ritmo. Cuando llegue el muro, recuerda por qu√© empezaste. ¬°Eres un maratonista, demu√©stralo! üèÉ‚Äç‚ôÇÔ∏èüí™üî•üéØ`
            };
            
            return messages[distance] || `¬°Vamos ${name}! Hoy es tu d√≠a. ¬°A darlo todo! üèÉ‚Äç‚ôÇÔ∏èüí™üî•`;
        }

        function formatPace(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function getPeriodDescription(period) {
            const descriptions = {
                'basico': 'Construcci√≥n de base aer√≥bica, desarrollo de resistencia general y fortalecimiento del sistema cardiovascular. Enfoque en volumen y adaptaci√≥n progresiva. Se establecen los cimientos para el trabajo intenso posterior.',
                'especifico': 'Desarrollo de capacidades espec√≠ficas para la distancia objetivo. Incremento de intensidad con intervalos y tempo runs. Mayor volumen en tiradas largas. Se trabaja la velocidad espec√≠fica y resistencia a la fatiga.',
                'competencia': 'Ajuste fino de ritmos de carrera. Simulaciones de competencia y trabajo de velocidad espec√≠fica. Reducci√≥n gradual de volumen (tapering) con mantenimiento de intensidad. Preparaci√≥n mental y f√≠sica para el d√≠a de la carrera.',
                'transicion': 'Recuperaci√≥n activa post-objetivo. Reducci√≥n significativa de volumen e intensidad para regeneraci√≥n completa y prevenci√≥n de lesiones. Permite que el cuerpo se recupere completamente del esfuerzo acumulado.'
            };
            return descriptions[period];
        }

        function displayPlan(plan) {
            const raceDateObj = new Date(plan.userData.raceDate);
            const raceDay = raceDateObj.toLocaleDateString('es-CL', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            let prepRacesHtml = '';
            if (plan.userData.prepRaces.length > 0) {
                prepRacesHtml = '<div class="info-item" style="grid-column: 1/-1;"><strong>Carreras Preparatorias</strong><br>';
                plan.userData.prepRaces.forEach(race => {
                    prepRacesHtml += `<span class="prep-race-badge">${race.name} - ${race.distance} - ${new Date(race.date).toLocaleDateString('es-CL')}</span>`;
                });
                prepRacesHtml += '</div>';
            }

            let crossTrainingHtml = '';
            if (plan.userData.crossTraining.length > 0) {
                crossTrainingHtml = '<div class="info-item" style="grid-column: 1/-1;"><strong>Entrenamiento Cruzado</strong><br><span>' + 
                    plan.userData.crossTraining.join(', ') + '</span></div>';
            }

            let techHtml = '';
            if (plan.userData.hasWatch) {
                techHtml = `<div class="info-item"><strong>Monitoreo</strong><span>Reloj Deportivo</span></div>`;
                if (plan.userData.vo2max) {
                    techHtml += `<div class="info-item"><strong>VO2 Max</strong><span>${plan.userData.vo2max} ml/kg/min</span></div>`;
                }
            }

            const planInfoHtml = `
                <div class="info-item">
                    <strong>Atleta</strong>
                    <span>${plan.userData.name}</span>
                </div>
                <div class="info-item">
                    <strong>Edad</strong>
                    <span>${plan.userData.age} a√±os</span>
                </div>
                <div class="info-item">
                    <strong>Experiencia</strong>
                    <span>${plan.userData.experience.charAt(0).toUpperCase() + plan.userData.experience.slice(1)}</span>
                </div>
                <div class="info-item">
                    <strong>Objetivo</strong>
                    <span>${plan.userData.distance}${plan.userData.firstTimeDistance ? ' (Primera vez)' : ''}</span>
                </div>
                <div class="info-item">
                    <strong>Fecha Objetivo</strong>
                    <span>${raceDay}</span>
                </div>
                <div class="info-item">
                    <strong>Ritmo Objetivo</strong>
                    <span>${plan.userData.pace}/km</span>
                </div>
                <div class="info-item">
                    <strong>Duraci√≥n Total</strong>
                    <span>${plan.totalWeeks} semanas</span>
                </div>
                <div class="info-item">
                    <strong>D√≠as Entrenamiento</strong>
                    <span>${plan.userData.trainingDays.length} d√≠as/semana</span>
                </div>
                ${techHtml}
                ${prepRacesHtml}
                ${crossTrainingHtml}
            `;
            document.getElementById('planInfo').innerHTML = planInfoHtml;

            const periodGroups = {
                basico: [],
                especifico: [],
                competencia: [],
                transicion: []
            };

            plan.weeklyPlans.forEach(week => {
                periodGroups[week.period].push(week);
            });

            let planHtml = '';
            
            Object.keys(periodGroups).forEach(periodKey => {
                if (periodGroups[periodKey].length === 0) return;
                
                const periodName = plan.periods[periodKey].name;
                const periodDescription = getPeriodDescription(periodKey);
                
                planHtml += `
                    <div class="period-section">
                        <div class="period-header">
                            ${periodName} (${periodGroups[periodKey].length} semanas)
                        </div>
                        <div class="period-description">
                            <strong>Enfoque del per√≠odo:</strong> ${periodDescription}
                        </div>
                `;
                
                periodGroups[periodKey].forEach(week => {
                    const weekClass = week.isRaceWeek ? 'week-card race-week' : 'week-card';
                    const headerClass = week.isRaceWeek ? 'week-header race-week-header' : 'week-header';
                    
                    planHtml += `
                        <div class="${weekClass}">
                            <div class="${headerClass}">
                                ${week.isRaceWeek ? 'üèÜüéØ ' : ''}Semana ${week.week} de ${plan.totalWeeks}${week.isRaceWeek ? ' - ¬°SEMANA DE COMPETENCIA!' : ''}
                                ${week.prepRace && !week.isRaceWeek ? `<br><span style="font-size: 0.9rem;">üèÅ ${week.prepRace.name} - ${week.prepRace.distance}</span>` : ''}
                            </div>
                            <div class="training-grid">
                    `;
                    
                    week.sessions.forEach(session => {
                        const dayClass = session.isRaceDay ? 'training-day race-day' : 'training-day';
                        
                        planHtml += `
                            <div class="${dayClass}">
                                ${session.isRaceDay ? '<div style="text-align: center; font-size: 2rem; margin-bottom: 1rem;">üèÜ üèÅ üéØ ‚≠ê</div>' : ''}
                                <div class="day-header">
                                    <div class="day-name">${session.day}</div>
                                    <div class="session-type">${session.type}</div>
                                    <div class="session-distance">${session.distance}</div>
                                </div>
                                
                                ${session.isRaceDay ? `
                                    <div class="motivational-message">
                                        ${session.motivationalMessage}
                                    </div>
                                ` : ''}
                                
                                <div class="session-details">
                                    <div class="session-phase">
                                        <div class="phase-title">üî• Calentamiento</div>
                                        <div class="phase-content">${session.details.warmup}</div>
                                    </div>
                                    <div class="session-phase">
                                        <div class="phase-title">üèÉ‚Äç‚ôÇÔ∏è Desarrollo</div>
                                        <div class="phase-content">${session.details.main}</div>
                                    </div>
                                    <div class="session-phase">
                                        <div class="phase-title">üßò‚Äç‚ôÇÔ∏è Enfriamiento</div>
                                        <div class="phase-content">${session.details.cooldown}</div>
                                    </div>
                                </div>

                                ${session.shoeRecommendation ? `
                                    <div class="shoe-recommendation">
                                        ${session.shoeRecommendation}
                                    </div>
                                ` : ''}

                                ${!session.isRaceDay ? `
                                    <div class="training-purpose">
                                        <div class="purpose-title">${session.purpose.title}</div>
                                        <div class="purpose-content">${session.purpose.content}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    planHtml += `
                            </div>
                            <div class="volume-summary">
                                üìä VOLUMEN SEMANAL: ${week.totalKm} KM
                                ${week.week % 4 === 0 && !week.isRaceWeek ? '<br><br>üíÜ‚Äç‚ôÇÔ∏è RECOMENDACI√ìN: Sesi√≥n de masaje deportivo o kinesiolog√≠a esta semana para optimizar recuperaci√≥n.' : ''}
                            </div>
                        </div>
                    `;
                });
                
                planHtml += `</div>`;
            });
            
            document.getElementById('trainingPlan').innerHTML = planHtml;
        }

        function generatePDF() {
            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert('Error al cargar la librer√≠a de PDF. Por favor recarga la p√°gina.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            
            // Title
            doc.setFontSize(20);
            doc.setTextColor(220, 20, 60);
            doc.setFont(undefined, 'bold');
            doc.text('OSORNO RUNNERS', 105, yPos, { align: 'center' });
            yPos += 8;
            doc.setFontSize(16);
            doc.text('PLAN DE ENTRENAMIENTO', 105, yPos, { align: 'center' });
            yPos += 15;
            
            // User info
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            
            const raceDateObj = new Date(currentPlan.userData.raceDate);
            const raceDay = raceDateObj.toLocaleDateString('es-CL');
            
            const userInfo = [
                ['Atleta:', currentPlan.userData.name, 'Edad:', `${currentPlan.userData.age} a√±os`],
                ['Experiencia:', currentPlan.userData.experience, 'Objetivo:', currentPlan.userData.distance],
                ['Ritmo:', `${currentPlan.userData.pace}/km`, 'Fecha:', raceDay],
                ['Duraci√≥n:', `${currentPlan.totalWeeks} sem.`, 'D√≠as/sem:', `${currentPlan.userData.trainingDays.length}`]
            ];
            
            if (currentPlan.userData.firstTimeDistance) {
                userInfo.push(['Primera vez:', 'S√≠', '', '']);
            }
            
            userInfo.forEach(row => {
                doc.setFont(undefined, 'bold');
                doc.text(row[0], 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(String(row[1]), 50, yPos);
                if (row[2]) {
                    doc.setFont(undefined, 'bold');
                    doc.text(row[2], 110, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.text(String(row[3]), 135, yPos);
                }
                yPos += 6;
            });
            
            yPos += 5;
            
            // Weekly plans por per√≠odo
            const periodGroups = {
                basico: [],
                especifico: [],
                competencia: [],
                transicion: []
            };

            currentPlan.weeklyPlans.forEach(week => {
                periodGroups[week.period].push(week);
            });
            
            Object.keys(periodGroups).forEach(periodKey => {
                if (periodGroups[periodKey].length === 0) return;
                
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Period header
                doc.setFillColor(26, 26, 26);
                doc.rect(20, yPos - 5, 170, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                const periodName = currentPlan.periods[periodKey].name.toUpperCase();
                doc.text(periodName, 105, yPos, { align: 'center' });
                yPos += 10;
                
                periodGroups[periodKey].forEach(week => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Week header
                    if (week.isRaceWeek) {
                        doc.setFillColor(255, 215, 0);
                        doc.rect(20, yPos - 4, 170, 8, 'F');
                        doc.setTextColor(26, 26, 26);
                    } else {
                        doc.setFillColor(220, 20, 60);
                        doc.rect(20, yPos - 4, 170, 7, 'F');
                        doc.setTextColor(255, 255, 255);
                    }
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    let weekText = week.isRaceWeek ? `SEMANA ${week.week} - COMPETENCIA` : `SEMANA ${week.week}`;
                    if (week.prepRace && !week.isRaceWeek) {
                        weekText += ` - ${week.prepRace.name}`;
                    }
                    doc.text(weekText, 105, yPos, { align: 'center' });
                    yPos += 9;
                    
                    // Sessions
                    week.sessions.forEach(session => {
                        if (yPos > 265) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        doc.setFontSize(8);
                        if (session.isRaceDay) {
                            doc.setTextColor(255, 140, 0);
                        } else {
                            doc.setTextColor(220, 20, 60);
                        }
                        doc.setFont(undefined, 'bold');
                        const sessionTitle = `${session.day.toUpperCase()} - ${session.type}`;
                        doc.text(sessionTitle, 20, yPos);
                        doc.setTextColor(0, 0, 0);
                        doc.text(String(session.distance), 180, yPos, { align: 'right' });
                        yPos += 4;
                        
                        if (session.isRaceDay && session.motivationalMessage) {
                            doc.setFontSize(7);
                            doc.setFont(undefined, 'italic');
                            doc.setTextColor(255, 140, 0);
                            const msgLines = doc.splitTextToSize(session.motivationalMessage, 170);
                            doc.text(msgLines, 22, yPos);
                            yPos += msgLines.length * 3.5 + 2;
                            doc.setTextColor(0, 0, 0);
                        }
                        
                        doc.setFontSize(7);
                        doc.setFont(undefined, 'normal');
                        
                        const details = [
                            `Cal: ${session.details.warmup}`,
                            `Des: ${session.details.main}`,
                            `Enf: ${session.details.cooldown}`
                        ];
                        
                        if (session.shoeRecommendation) {
                            details.push(session.shoeRecommendation);
                        }
                        
                        details.forEach(detail => {
                            const lines = doc.splitTextToSize(detail, 170);
                            doc.text(lines, 22, yPos);
                            yPos += lines.length * 3.5;
                        });
                        
                        yPos += 2;
                    });
                    
                    // Volume summary
                    doc.setFillColor(26, 26, 26);
                    doc.rect(20, yPos, 170, 6, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.text(`VOLUMEN: ${week.totalKm} KM`, 105, yPos + 4, { align: 'center' });
                    yPos += 10;
                });
            });
            
            // Save PDF
            const fileName = `Plan_OsornoRunners_${currentPlan.userData.name.replace(/\s+/g, '_')}_${currentPlan.userData.distance}.pdf`;
            doc.save(fileName);
        }
    </script>
</body>
</html>